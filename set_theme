#!/bin/bash

# exit when any command fails
set -e
# keep track of the last executed command
trap 'last_command=$current_command; current_command=$BASH_COMMAND' DEBUG
# echo an error message before exiting
trap 'echo "\"${last_command}\" command filed with exit code $?."' EXIT

help() {
    echo 'usage: set_theme [theme] [flags]'
    echo
    echo '  no args           use menu to set theme and background'
    echo '  --no-bg           dont set default background for theme'
    echo '  -a, --alpha       set alpha value to float supplied'
    echo '  -h, --help        u a dum'
}

firefox_dir="/home/gurjal/.mozilla/firefox/basm5cql.default-default"
dunst_dir="$HOME/.config/dunst"
theme=''

set_theme_bg() {
    case "$1" in
        1  | ayu)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/267592.jpeg"
            theme='ayu'
            ;;
        2  | palenight)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/outset_island_night.jpg"
            theme='palenight'
            ;;
        3  | everforest)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/island_trees.jpeg"
            theme='everforest'
            ;;
        4  | rose_pine)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/b6hhyxfslq051.jpg"
            theme='rose_pine'
            ;;
        5  | gruvbox_material)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/2k/orange_harbor_city_painter.jpg"
            theme='gruvbox_material'
            ;;
        6  | embark)
            # set_bg -r0 -b "/home/$USER/Pictures/wallpapers/3k/694956.jpg"
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/purple_peach_mountain_sunset.jpg"
            theme='embark'
            ;;
        7  | tokyo_night)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/3k/tatami-room-wallpaper-cropped.jpg"
            theme='tokyo_night'
            ;;
        8  | nord)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/Colorthemes/Nord/Nordic6_cropped.jpg"
            theme='nord'
            ;;
        9  | moonfly)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/870592.jpeg"
            theme='moonfly'
            ;;
        10 | seoul256)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/outset_island_night.jpg"
            theme='seoul256'
            ;;
        11 | tundra)
            set_bg -r0 -b "/home/$USER/Pictures/wallpapers/4k/0oui0mtf451a1.jpg"
            theme='tundra'
            ;;
    esac
}

if [ -z "$1" ]; then
    echo "1  -> ayu"
    echo "2  -> palenight"
    echo "3  -> everforest"
    echo "4  -> rose_pine"
    echo "5  -> gruvbox_material"
    echo "6  -> embark"
    echo "7  -> tokyo_night"
    echo "8  -> nord"
    echo "9  -> moonfly"
    echo "10 -> seoul256"
    echo "11 -> tundra"
    read -p "which theme? " opt
    set_theme_bg $opt
else
    while [ -n "$1" ]; do
        case "$1" in
            -h | --help)
                help
                exit
                ;;
            --no-bg)
                no_bg=1
                ;;
            *)
                theme=$1
                ;;
        esac
        shift
    done
fi

# set background if needed
if [ -z "$no_bg" ]; then
    set_theme_bg $theme
fi

# [[ -x /usr/bin/pkill ]] && pkill firefox
# [[ -x /usr/bin/killall ]] && killall firefox

# set dunst color
cp ".config/dunst/dunstrc" "$dunst_dir/"
cat ".config/themes/$theme/dunst/dunstrc_color" >>"$dunst_dir/dunstrc"

# set firefox css
cp ".config/firefox/userChrome.css" "$firefox_dir/chrome"
cp ".config/themes/$theme/firefox/userColors.css" "$firefox_dir/chrome"

# set blank page color
normal_bg=$(cat ".config/themes/$theme/firefox/userColors.css" | grep 'normal_bg' |
    awk '{print $2}' | cut -b -7)
sed -i '/browser.display.background_color.dark/d' "$firefox_dir/prefs.js"
echo "user_pref(\"browser.display.background_color.dark\", \"$normal_bg\");" >>"$firefox_dir/prefs.js"

# qutebrowser
sed -i '/config.source/d' "$HOME/.config/qutebrowser/config.py"
echo "config.source('themes/$theme.py')" >> "$HOME/.config/qutebrowser/config.py"

# neovim
# sed -i "s/colo.*'/colo.$theme'/g" $HOME/.config/nvim/init.lua

# kakoune
# sed -i "/colorscheme/c\colorscheme $theme" "$HOME/.config/kak/kakrc"

# set st and dwm themes then compile
sed -i "s+themes/.*+themes/$theme.h\"+g" tabbed/config.h
sed -i "s+themes/.*+themes/$theme.h\"+g" st/config.h
sed -i "s+themes/.*+themes/$theme.h\"+g" dwm/config.h
cd tabbed
sudo make clean install
cd ../st
sudo make clean install
cd ../dwm
sudo make clean install
cd ..
# [[ -x /usr/bin/pkill ]] && pkill dwm
# [[ -x /usr/bin/killall ]] && killall dwm
echo
echo 'restart dwm'
echo
